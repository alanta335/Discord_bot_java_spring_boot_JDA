# Discord Music Bot

A Spring Boot-based Discord bot that combines music playback capabilities with AI-powered knowledge graph features. Built with JDA, LavaPlayer, Neo4j, and LangChain4j.

## Features

### Music Features
- ğŸµ Play music from various sources (YouTube, SoundCloud, etc.)
- ğŸ“‹ Queue management with multiple tracks
- â­ï¸ Skip tracks
- â¹ï¸ Stop music and clear queue
- ğŸ“Š View current queue
- ğŸ“ Ping command for bot status
- ğŸ”§ Configurable audio settings
- ğŸ“ Comprehensive logging

### Knowledge Graph Features
- ğŸ§  **Knowledge Graph Integration**: Extract and store knowledge from chat messages in Neo4j
- ğŸ” **Graph-based Q&A**: Query stored knowledge using natural language
- ğŸ¤– **AI Agents**: LangChain4j-powered agents for graph extraction and querying
- ğŸ“¥ **Message Fetching**: Bulk import channel messages into the knowledge graph
- ğŸ”„ **Automatic Extraction**: Automatically processes messages in batches to build the knowledge graph

## Commands

### Music Commands
- `/play <song>` - Play a song or add it to the queue
- `/skip` - Skip the current song
- `/stop` - Stop music and clear the queue
- `/queue` - Show the current queue
- `/ping` - Check bot status and latency

### Knowledge Graph Commands
- `/ask <question>` - Ask a question and get an answer based on the knowledge graph
- `/fetch` - Fetch all messages from the current channel and extract knowledge into the graph

## Knowledge Graph Features

The bot includes advanced knowledge graph capabilities powered by Neo4j and LangChain4j:

### Graph Extraction
- Automatically extracts structured knowledge from chat messages
- Identifies entities, relationships, and properties from conversations
- Converts extracted knowledge into graph format (nodes, relationships, paths)
- Processes messages in batches of 20 for efficient extraction

### Graph Storage
- Stores knowledge graphs in Neo4j database
- Uses Cypher queries generated by AI agents
- Supports MERGE operations to avoid duplicates
- Transactional operations ensure data consistency

### Natural Language Querying
- Query stored knowledge using natural language questions
- Uses `Neo4jText2CypherRetriever` to convert questions to Cypher queries
- Returns friendly, formatted answers based on graph data
- Personalized responses with user context

### AI Agents
- **ChatToGraphAgent**: Extracts knowledge graphs from chat messages using OpenAI
- **GraphToCypherQueryAgent**: Converts graph structures to executable Cypher commands
- **FriendlyAnswerAgent**: Formats query results into natural language responses

### Workflow
1. Use `/fetch` to import channel messages
2. Messages are processed in batches and sent to `ChatToGraphAgent`
3. Extracted knowledge is converted to Cypher queries by `GraphToCypherQueryAgent`
4. Queries are executed against Neo4j to build the knowledge graph
5. Use `/ask` to query the graph with natural language questions

## Configuration

### Environment Variables

Set the following environment variables:
```bash
DISCORD_BOT_TOKEN=your_discord_bot_token_here
OPENAI_API_KEY=your_openai_api_key_here
```

### Application Properties

The bot can be configured through `application.yaml`:

```yaml
# Discord Bot Configuration
discord:
  token: ${DISCORD_BOT_TOKEN}

# Neo4j Configuration
spring:
  neo4j:
    uri: bolt://localhost:7687
    authentication:
      username: neo4j
      password: YourStrongPasswordHere
  data:
    neo4j:
      database: neo4j

# Audio Configuration
audio:
  frame-buffer-duration: 10000
  item-loader-thread-pool-size: 10

# AI Configuration
ai:
  api_key: ${OPENAI_API_KEY}

# Logging Configuration
logging:
  level:
    com.discord.bot: INFO
    net.dv8tion.jda: WARN
    com.sedmelluq.discord.lavaplayer: WARN
```

## Setup

### Prerequisites
- Java 21 or higher
- Maven 3.6 or higher
- Docker and Docker Compose (for Neo4j)
- Discord Bot Token ([Create a bot](https://discord.com/developers/applications))
- OpenAI API Key ([Get your API key](https://platform.openai.com/api-keys))

### Installation Steps

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd bot
   ```

2. **Set environment variables**
   
   Create a `.env` file or set the following environment variables:
   ```bash
   DISCORD_BOT_TOKEN=your_discord_bot_token_here
   OPENAI_API_KEY=your_openai_api_key_here
   ```

3. **Start Neo4j database**
   ```bash
   docker-compose up -d
   ```
   
   This will start Neo4j with:
   - Web UI: http://localhost:7474 (default credentials: `neo4j/YourStrongPasswordHere`)
   - Bolt connection: `bolt://localhost:7687`
   - APOC plugin enabled for advanced graph operations

4. **Configure application**
   
   Update `src/main/resources/application.yaml` if needed:
   - Neo4j password (default: `YourStrongPasswordHere`)
   - Audio settings
   - Logging levels

5. **Build and run the application**
   ```bash
   mvn clean install
   mvn spring-boot:run
   ```

6. **Invite bot to your Discord server**
   
   Use the OAuth2 URL generator in Discord Developer Portal:
   - Scopes: `bot`, `applications.commands`
   - Bot Permissions: `Send Messages`, `Connect`, `Speak`, `Use Slash Commands`

## Architecture

### Project Structure

```
src/main/java/com/discord/bot/
â”œâ”€â”€ BotApplication.java              # Main Spring Boot application
â”œâ”€â”€ config/                          # Configuration classes
â”‚   â”œâ”€â”€ AgentConfig.java            # AI agent configurations
â”‚   â”œâ”€â”€ AudioConfig.java            # LavaPlayer audio settings
â”‚   â”œâ”€â”€ ChatModelConfig.java        # OpenAI model configuration
â”‚   â”œâ”€â”€ GraphConfig.java            # Neo4j and retriever setup
â”‚   â””â”€â”€ JdaConfig.java              # Discord JDA client setup
â”œâ”€â”€ event_listener/
â”‚   â””â”€â”€ ChatMessageEventListener.java  # Slash command handler
â”œâ”€â”€ feature_chat/
â”‚   â””â”€â”€ ChatService.java            # Chat and message processing
â”œâ”€â”€ feature_knowledge_graph/
â”‚   â”œâ”€â”€ agent/                      # AI agents
â”‚   â”‚   â”œâ”€â”€ ChatToGraphAgent.java
â”‚   â”‚   â”œâ”€â”€ GraphToCypherQueryAgent.java
â”‚   â”‚   â””â”€â”€ FriendlyAnswerAgent.java
â”‚   â”œâ”€â”€ domain/                     # Domain models
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â””â”€â”€ KGService.java          # Knowledge graph operations
â”‚   â””â”€â”€ util/                       # Utility classes
â”œâ”€â”€ feature_music/
â”‚   â””â”€â”€ service/                    # Music playback services
â”‚       â”œâ”€â”€ MusicService.java
â”‚       â”œâ”€â”€ GuildMusicManager.java
â”‚       â””â”€â”€ TrackScheduler.java
â””â”€â”€ properties/
    â””â”€â”€ OpenAIProperties.java       # Configuration properties
```

### Key Components

#### Discord Integration
- **JdaConfig**: Configures the Discord JDA client, registers slash commands, and handles bot lifecycle
- **ChatMessageEventListener**: Handles all slash command interactions and routes to appropriate services

#### Music Features
- **MusicService**: Manages music managers for different Discord guilds (servers)
- **GuildMusicManager**: Manages audio player and scheduler for a specific guild
- **TrackScheduler**: Handles track queuing, playback, and queue management
- **AudioConfig**: Configures LavaPlayer audio settings (frame buffer, thread pool)

#### Knowledge Graph Features
- **GraphConfig**: Configures Neo4j database connection and LangChain4j retrievers
- **KGService**: Main service for knowledge graph operations (extraction, storage, querying)
- **ChatToGraphAgent**: AI agent that extracts knowledge graphs from chat messages
- **GraphToCypherQueryAgent**: AI agent that converts graph structures to Cypher queries
- **FriendlyAnswerAgent**: AI agent that formats natural language answers from graph queries
- **Neo4jText2CypherRetriever**: LangChain4j retriever for querying Neo4j with natural language
- **ChatService**: Handles message fetching and coordinates knowledge extraction

### Data Flow

1. **Message Processing**:
   - User runs `/fetch` â†’ `ChatService.fetchAllMessages()`
   - Messages are batched (100 per batch) and processed
   - Each batch of 20 messages is sent to `ChatToGraphAgent`

2. **Knowledge Extraction**:
   - `ChatToGraphAgent` extracts entities, relationships, and properties
   - `GraphToCypherQueryAgent` converts extracted knowledge to Cypher queries
   - `KGService.createKNGraph()` executes queries against Neo4j

3. **Query Processing**:
   - User runs `/ask <question>` â†’ `ChatService.getAnswerToQuestion()`
   - `Neo4jText2CypherRetriever` converts question to Cypher query
   - Query results are formatted by `FriendlyAnswerAgent`

## Dependencies

### Core Framework
- **Spring Boot** 3.5.6 - Application framework
- **Spring Data Neo4j** - Neo4j database integration
- **Lombok** - Code generation and boilerplate reduction

### Discord Integration
- **JDA** 5.0.0-beta.20 - Discord API client library

### Audio Processing
- **LavaPlayer** 2.2.4 - Audio player for Discord (supports YouTube, SoundCloud, etc.)

### AI & Knowledge Graph
- **LangChain4j** 1.8.0-beta15 - AI framework for Java
  - `langchain4j-open-ai-spring-boot-starter` - OpenAI integration
  - `langchain4j-agentic` - AI agent framework
  - `langchain4j-community-neo4j` - Neo4j integration
  - `langchain4j-community-neo4j-retriever` - Text-to-Cypher retriever

### Database
- **Neo4j** (via Docker) - Graph database for knowledge storage

## Requirements

- **Java** 21 or higher
- **Maven** 3.6 or higher
- **Docker** and **Docker Compose** (for Neo4j)
- **Discord Bot Token** ([Get one here](https://discord.com/developers/applications))
- **OpenAI API Key** ([Get one here](https://platform.openai.com/api-keys))

## Usage Examples

### Music Commands
```
/play Never Gonna Give You Up
/play https://www.youtube.com/watch?v=dQw4w9WgXcQ
/skip
/queue
/stop
```

### Knowledge Graph Commands
```
/fetch                    # Import all messages from current channel
/ask What did we discuss about the project?
/ask Who mentioned Java?
/ask What are the main topics in this channel?
```

## Troubleshooting

### Bot doesn't respond to commands
- Verify the bot is online in your Discord server
- Check that slash commands are registered (may take a few minutes after startup)
- Ensure the bot has necessary permissions

### Music playback issues
- Ensure you're in a voice channel when using `/play`
- Check that the bot has permission to join and speak in voice channels
- Verify audio source URLs are valid

### Knowledge graph not working
- Ensure Neo4j is running: `docker ps` should show the neo4j container
- Check Neo4j connection in `application.yaml`
- Verify OpenAI API key is set correctly
- Check application logs for errors

### Neo4j connection errors
- Verify Neo4j is running: `docker-compose ps`
- Check credentials in `application.yaml` match Docker Compose settings
- Ensure port 7687 is not blocked by firewall

## Development

### Building the Project
```bash
mvn clean install
```

### Running Tests
```bash
mvn test
```

### Running in Development Mode
```bash
mvn spring-boot:run
```

### Viewing Logs
Logs are configured in `application.yaml` and output to console. Check `neo4j/logs/` for Neo4j logs.

## Contributing

This is an educational project. Feel free to fork and modify for your own use.

## License

This project is for educational purposes.
